name: CRA Comparative Test

on:
  workflow_dispatch:
    inputs:
      task_description:
        description: 'Task for agents to complete'
        required: true
        default: 'Create a SoundWave music streaming landing page with VIB3+ audio-reactive background'

jobs:
  test-without-cra:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup
        run: mkdir -p output

      - name: Run Claude WITHOUT CRA
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          npm install -g @anthropic-ai/claude-code

          # Run Claude with the task - it will use tools to create files
          claude -p "
          Task: ${{ github.event.inputs.task_description }}

          Requirements:
          1. Create complete HTML file at output/index.html
          2. Use VIB3+ for animated background
          3. Make it audio-reactive
          4. Include styling and call-to-action

          Then create output/REPORT.md documenting:
          - What you knew vs guessed about VIB3+
          - Confidence level 1-10

          Create both files now.
          " --allowedTools "Write,Edit,Bash" --max-turns 20

      - name: List output
        run: ls -la output/ || echo "No output directory"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: without-cra
          path: output/
          if-no-files-found: warn

  test-with-cra:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build CRA
        run: cargo build --release -p cra-mcp

      - name: Setup
        run: |
          mkdir -p output
          mkdir -p .claude
          cat > .claude/settings.json << 'EOF'
          {
            "mcpServers": {
              "cra": {
                "command": "./target/release/cra-mcp-server",
                "args": ["-a", "test-atlases"]
              }
            }
          }
          EOF

      - name: Run Claude WITH CRA
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          npm install -g @anthropic-ai/claude-code

          # Run Claude with CRA MCP available
          claude -p "
          Task: ${{ github.event.inputs.task_description }}

          Requirements:
          1. Create complete HTML file at output/index.html
          2. Use VIB3+ for animated background
          3. Make it audio-reactive
          4. Include styling and call-to-action

          Use CRA tools.

          Then create output/REPORT.md documenting:
          - What CRA context you received
          - Confidence level 1-10

          Create both files now.
          " --allowedTools "Write,Edit,Bash,mcp__cra__*" --max-turns 20

      - name: List output
        run: ls -la output/ || echo "No output directory"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: with-cra
          path: output/
          if-no-files-found: warn

  compare:
    needs: [test-without-cra, test-with-cra]
    runs-on: ubuntu-latest

    steps:
      - name: Download results
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Compare
        run: |
          echo "# CRA Comparative Test Results"
          echo ""
          echo "## WITHOUT CRA"
          echo "### Report:"
          cat without-cra/REPORT.md 2>/dev/null || echo "No report generated"
          echo ""
          echo "### HTML (first 50 lines):"
          head -50 without-cra/index.html 2>/dev/null || echo "No HTML generated"
          echo ""
          echo "---"
          echo ""
          echo "## WITH CRA"
          echo "### Report:"
          cat with-cra/REPORT.md 2>/dev/null || echo "No report generated"
          echo ""
          echo "### HTML (first 50 lines):"
          head -50 with-cra/index.html 2>/dev/null || echo "No HTML generated"
