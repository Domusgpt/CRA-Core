version: '3.8'

# CRA + MINOOTS Integration Demo
#
# This Compose file provides all three layers of CRA governance:
#   - Layer 1: Context Injection (via atlases)
#   - Layer 2: MCP Server (tool filtering, pre-flight checks)
#   - Layer 3: Webhook Proxy (hard network-level enforcement)
#
# Usage:
#   docker-compose up -d
#   # CRA server: http://localhost:8420
#   # CRA MCP:    localhost:8421 (stdio over TCP)
#   # CRA Proxy:  http://localhost:8422

services:
  # ─────────────────────────────────────────────────────────────────────────
  # Layer 1 + Core: CRA Server with Atlas loading
  # ─────────────────────────────────────────────────────────────────────────
  cra-server:
    build:
      context: ../..
      dockerfile: examples/minoots-integration/Dockerfile.cra-server
    ports:
      - "8420:8420"
    environment:
      - CRA_PORT=8420
      - CRA_ATLAS_DIR=/atlases
      - RUST_LOG=info,cra_server=debug
    volumes:
      - ./atlases:/atlases:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8420/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - cra-minoots

  # ─────────────────────────────────────────────────────────────────────────
  # Layer 2: Self-Documenting MCP Server
  # ─────────────────────────────────────────────────────────────────────────
  cra-mcp:
    build:
      context: ../..
      dockerfile: examples/minoots-integration/Dockerfile.cra-mcp
    ports:
      - "8421:8421"
    environment:
      - CRA_MCP_PORT=8421
      - CRA_ATLAS_DIR=/atlases
      - RUST_LOG=info,cra_mcp=debug
    volumes:
      - ./atlases:/atlases:ro
    depends_on:
      cra-server:
        condition: service_healthy
    networks:
      - cra-minoots

  # ─────────────────────────────────────────────────────────────────────────
  # Layer 3: Webhook Proxy Gateway (Hard Enforcement)
  # ─────────────────────────────────────────────────────────────────────────
  cra-proxy:
    build:
      context: ../..
      dockerfile: examples/minoots-integration/Dockerfile.cra-proxy
    ports:
      - "8422:8422"
    environment:
      - CRA_PROXY_PORT=8422
      - CRA_SERVER_URL=http://cra-server:8420
      - RUST_LOG=info,cra_proxy=debug
      # Security: Block internal networks by default
      - CRA_BLOCK_INTERNAL=true
      - CRA_BLOCK_METADATA=true
    depends_on:
      cra-server:
        condition: service_healthy
    networks:
      - cra-minoots

  # ─────────────────────────────────────────────────────────────────────────
  # Test Services
  # ─────────────────────────────────────────────────────────────────────────

  # Webhook test server (for demo purposes)
  webhook-receiver:
    image: node:20-alpine
    command: >
      sh -c "
        cat > /app/server.js << 'EOF'
        const http = require('http');
        const server = http.createServer((req, res) => {
          let body = '';
          req.on('data', chunk => body += chunk);
          req.on('end', () => {
            console.log(`[${new Date().toISOString()}] ${req.method} ${req.url}`);
            console.log('Headers:', JSON.stringify(req.headers, null, 2));
            if (body) console.log('Body:', body);
            res.writeHead(200, {'Content-Type': 'application/json'});
            res.end(JSON.stringify({received: true, timestamp: new Date().toISOString()}));
          });
        });
        server.listen(3000, () => console.log('Webhook receiver on :3000'));
        EOF
        node /app/server.js
      "
    ports:
      - "3000:3000"
    networks:
      - cra-minoots

  # Internal service (for SSRF testing - proxy should block this)
  internal-service:
    image: nginx:alpine
    # No external port mapping - only accessible internally
    networks:
      cra-minoots:
        ipv4_address: 192.168.100.100

networks:
  cra-minoots:
    name: cra-minoots-network
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.100.0/24

# ─────────────────────────────────────────────────────────────────────────
# Integration Notes
# ─────────────────────────────────────────────────────────────────────────
#
# For full integration, MINOOTS services connect to this network:
#
# # In MINOOTS docker-compose.yml, add:
# networks:
#   cra-minoots:
#     external: true
#     name: cra-minoots-network
#
# # And configure action-orchestrator:
# action-orchestrator:
#   environment:
#     - CRA_ENDPOINT=http://cra-server:8420
#     - CRA_MCP_ENDPOINT=http://cra-mcp:8421
#     - CRA_PROXY=http://cra-proxy:8422
#     - CRA_ENABLED=true
#   networks:
#     - cra-minoots
